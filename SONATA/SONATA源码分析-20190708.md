# SONATA源码分析
## 1. 目录结构
```js
sonata/
  - core/                // 运行时、Query Partition功能
    - lp/                // 整数规划
    - training/          // 历史数据训练
    - runtime.py         // 运行时
    - refinement.py      // 优化
    - partition.py       // 查询任务分割
    - utils.py           // 其他功能封装
  - query_engine/        // 可声名式抽象查询
    - sonata_operators/  // Query操作符(map、filter、join等)封装
    - sonata_queries.py  // PacketStream类封装
    - utils.py           // Query其他功能封装
  - dataplane_driver/    // 数据平面驱动
  - streaming_driver/    // 流处理器驱动
```
## 2. 模块源码分析
### 2.1 core模块源码分析
- runtime.py
  - 功能：运行时模块
  - 属性变量：
    - dp_queries={} | sp_queries={}
    - query_plans={} | refinement_keys={}
    - query_in_mappings={} | query_out_mappings={} | query_out_final={}
    - op_handler_socket=None | op_handler_listener=None
  - 方法函数：
    - init
    - query_has_join_in_same_window
    - get_sonata_layers
    - update_query_mappings
    - start_op_handler
    - **start_dataplane_driver**
    - start_streaming_driver
    - compile
    - send_to_sm
    - send_init_to_dp_driver
    - send_to_dp_driver
    - initialize_handlers
    - initialize_logging
- partition.py
  - 功能：Query分区
  - 方法函数：
    - init
    - get_dataplane_query
    - get_streaming_query

### 2.2 query_engine模块源码分析
- sonata_queries.py
  - 功能：封装PacketStream类
- sonata_operators/
  - 功能：PacketStream各种元操作或组成
  - 子模块：filed | layer | query | map | reduce | filter | distinct | join
- utils/
  - 功能：PacketStream辅助函数
### 2.3 dataplane_driver模块源码分析
- dp_driver.py
  - 功能：封装DataplaneDriver类
  - 方法函数：
    - init
    - initialize_metrics_logger
    - start
    - add_target
    - is_supportable
    - get_cost
    - configure
    - update_configuration
    - get_target
### 2.4 streaming_driver模块源码分析
